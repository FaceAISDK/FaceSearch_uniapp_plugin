{"version":3,"sources":["uni_modules/FaceAI-Search/utssdk/app-android/index.uts","uni_modules/FaceAI-Search/utssdk/interface.uts"],"sourcesContent":["import { StartFaceSearch,AddFaceSearchFeature,DeleteFaceSearchFeature,FaceSearch,InsertFaceSearchFeature,ResultJSON, InsertManyFeatures} from '../interface.uts'\n\nimport Application from 'android.app.Application';\nimport Activity from 'android.app.Activity';\nimport Intent from 'android.content.Intent';\nimport FaceSDKConfig from \"com.faceAI.demo.FaceSDKConfig\";\nimport FaceAISDKNative from \"uts.sdk.modules.uniFaceAISDK.FaceAISDKNative\";\nimport FaceSearchActivity from \"uts.sdk.modules.uniFaceAISDK.FaceSearchActivity\";\nimport FaceResultManager from \"uts.sdk.modules.uniFaceAISDK.FaceResultManager\";\nimport System from 'java.lang.System'; // 引入 System 类以获取时间戳\nimport AddFaceImageActivity from \"com.faceAI.demo.SysCamera.addFace.AddFaceImageActivity\";\nimport BitmapUtils from \"com.faceAI.demo.base.utils.BitmapUtils\";\nimport FaceSearch1NActivity from 'com.faceAI.demo.SysCamera.search.FaceSearch1NActivity';\nimport FaceSearchFeatureManger from 'com.ai.face.faceSearch.search.FaceSearchFeatureManger';\n\n//当前libs目录下为空，复用了HelloKitty 的\n\n//*******************************     下面是1:N 人脸搜索识别的方法（仅Android） ************************************************\n\n /**\n  * 启动持续人脸搜索 Activity\n  * 该方法会启动 Activity 并不关闭，持续回调数据\n  */\n export const startFaceSearch: StartFaceSearch = function(callback: (jsonResult: string) => void) {\n\t \n\t UTSAndroid.getUniActivity()!.runOnUiThread(() => {\n\t \tconst context = UTSAndroid.getUniActivity() as Activity\n\t \tFaceSDKConfig.init(context);\n\t\t// UTS 会自动将这个 (json: string) => void 转换为 Kotlin 的 (String) -> Unit\n\t\tFaceResultManager.setCallback((json: string) => {\n\t\t    callback(json);\n\t\t});\n\t\t \n\t\t// 2. 启动搜索 Activity\n\t\tconst intent = new Intent(context, FaceSearchActivity().javaClass);\n\t\t// 如果需要设置 Activity 为 SingleTop 或其他启动模式，可以在这里 addFlags\n\t\tcontext.startActivity(intent);\t\n\t });\n }\n \n\n\n/**\n * 「1:N人脸搜索」人脸搜索人脸特征更新同步\n * 自行保证人脸特征值长度为1024\n */\nexport const insertFaceSearchFeature: InsertFaceSearchFeature = function (\n    faceID: string,\n    faceFeature: string,\n    tag: string,\n    group: string,\n    callback: (result: ResultJSON) => void\n) {\n    // 1. 获取 Context\n    const context = UTSAndroid.getAppContext() as Application\n    FaceSDKConfig.init(context);\n\n    // 2. 【校验】验证 faceID 不能为空\n    if (faceID == null || faceID.trim() == \"\") {\n        const errorResult: ResultJSON = {\n            code: -1, // 错误码\n            msg: \"参数错误: faceID 不能为空\",\n            faceID: \"\",\n            faceBase64: \"\",\n            faceFeature: \"\"\n        }\n        console.error(errorResult.msg)\n        callback(errorResult)\n        return // 终止执行\n    }\n\n    // 3. 【校验】验证 faceFeature 长度必须为 1024\n    if (faceFeature == null || faceFeature.length != 1024) {\n        const currentLen = (faceFeature == null) ? 0 : faceFeature.length;\n        const errorResult: ResultJSON = {\n            code: -2, // 错误码\n            msg: \"参数错误: faceFeature 长度必须为 1024 (当前长度: \" + currentLen + \")\",\n            faceID: faceID,\n            faceBase64: \"\",\n            faceFeature: \"\"\n        }\n        console.error(errorResult.msg)\n        callback(errorResult)\n        return // 终止执行\n    }\n\n    // 4. 【执行】调用 Native 方法，并增加异常捕获\n    try {\n        // tag 和 group 可以用来做标记和分组\n        // 建议：如果 tag/group 为空，可以传默认值，防止 Native 端空指针（视 Native 实现而定）\n        const safeTag = (tag == null) ? \"\" : tag;\n        const safeGroup = (group == null) ? \"\" : group;\n\n        const isSuccess = FaceSearchFeatureManger.getInstance(context)\n            .insertFaceFeature(faceID, faceFeature, System.currentTimeMillis(), safeTag, safeGroup);\n\n        // 假设 Native 方法返回 boolean (如果 Native 是 void，则这里只代表调用成功)\n        // 构造成功回调\n        const successResult: ResultJSON = {\n            code: 1,\n            msg: \"success\", // 或者 \"插入成功\"\n            faceID: faceID,\n            faceBase64: \"\",\n            faceFeature: \"\" // 为了节省传输开销，回调通常不再把巨大的特征值传回去\n        }\n        callback(successResult)\n\n    } catch (e: Exception) {\n        // 5. 【异常处理】捕获 Java 层可能的崩溃\n        const catchResult: ResultJSON = {\n            code: -3,\n            msg: \"Native 执行异常: \" + e.message,\n            faceID: faceID,\n            faceBase64: \"\",\n            faceFeature: \"\"\n        }\n        console.error(\"insertFaceSearchFeature error: \" + e.message)\n        callback(catchResult)\n    }\n}\n \n \n \n \n /**\n  *  「1:N人脸搜索」批量插入人脸特征数据\n  *   自行保证人脸特征值长度为1024\n  */\n export const insertManyFeatures : InsertManyFeatures = \n   function (jsonFaceFeatures : string, \n   callback : (result : ResultJSON) => void) {\n \t    const context = UTSAndroid.getAppContext() as Application\n \t    FaceSDKConfig.init(context);\t\n \t\n\t\tlet faceCount = FaceSearchFeatureManger.getInstance(context)\n\t\t                .insertFeatures(jsonFaceFeatures)\n \t\n \t\tconst resultJson:ResultJSON={\n \t\t\t\tcode:faceCount,\n \t\t\t\tmsg:\"success\",\n \t\t\t\tfaceID:\"\",\n \t\t\t\tfaceBase64:\"\",\n \t\t\t\tfaceFeature:\"\"\n \t\t\t}\t\n \t\tcallback(resultJson)\n \t})\n }\n \n \n \n \n \n /**\n  *  「1:N人脸搜索」人脸搜索人脸特征更新同步\n  */\n export const deleteFaceSearchFeature : DeleteFaceSearchFeature = \n   function (faceID : string, callback : (result : ResultJSON) => void) {\n \t    const context = UTSAndroid.getAppContext() as Application\n \t    FaceSDKConfig.init(context);\t\n \t\n        //清除所有人脸搜索所有特征\n        FaceSearchFeatureManger.getInstance(context).deleteFaceFaceFeature(faceID);\n \t\n \t\tconst resultJson:ResultJSON={\n \t\t\t\tcode:1,\n \t\t\t\tmsg:\"delete success\",\n \t\t\t\tfaceID:faceID,\n \t\t\t\tfaceBase64:\"\",\n \t\t\t\tfaceFeature:\"\"\n \t\t\t}\t\n \t\tcallback(resultJson)\n \t})\n }\n \n\n/**\n * 「1:N人脸搜索」跳转到Android SDK中原生相机页面处理人脸录入\n * \n * @param faceID 用户ID\n * @param addFacePerformanceMode 添加人脸角度检测模式. 1 快速模式   2 精确模式\n * @param callback 结果回调\n */\nexport const addFaceSearchFeature : AddFaceSearchFeature = function (\n    faceID:string,\n\taddFacePerformanceMode:number,\n\tcallback : (result : ResultJSON) => void\n) {\n\t\n\tUTSAndroid.getUniActivity()!.runOnUiThread(() => {\n\t\tconst context = UTSAndroid.getUniActivity() as Activity\n\t\tFaceSDKConfig.init(context);\n\t\tconst intent = new Intent(context, AddFaceImageActivity().javaClass)\n\t\tintent.putExtra(\"ADD_FACE_IMAGE_TYPE_KEY\", \"FACE_SEARCH\");\n\t\tintent.putExtra(\"ADD_FACE_PERFORMANCE_MODE\", addFacePerformanceMode);\n\t\tcontext.startActivityForResult(intent, 10086)\n\t});\n\t\n    //语法不熟悉，先保证主流程跑通\n\tUTSAndroid.onAppActivityResult((requestCode : Int, resultCode : Int, intentAct?: Intent) => {\n\t\tif (requestCode == 10086) {\n\t\t\tif(intentAct!=null){\n\t\t\t\tconst codeNow:number = intentAct.getIntExtra(\"code\",0) as number\n\t\t\t\tconst msgNow:string=intentAct.getStringExtra(\"msg\") as string\n                const faceFeatureNoew:string=intentAct.getStringExtra(\"faceFeature\") as string\n\t\t\t\t\n\t\t\t\tlet faceBase64=\"?\"\n\t\t\t\tif(0!=codeNow){\n\t\t\t\t\t//用户取消了就不应该有这个值\n\t\t\t\t\tfaceBase64=BitmapUtils.bitmapToBase64(FaceSDKConfig.CACHE_BASE_FACE_DIR+faceID)\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\tconst resultJson:ResultJSON={\n\t\t\t\t\tcode:codeNow,\n\t\t\t\t\tmsg:msgNow,\n\t\t\t\t\tfaceFeature: faceFeatureNoew,\n\t\t\t\t\tfaceID:\"\",\n\t\t\t\t\tfaceBase64:faceBase64\n\t\t\t\t}\t\t\n\t\t\t\tconsole.log(\"添加人脸人脸：\"+resultJson)\n\t\t\t\tcallback(resultJson)\n\t\t\t}else{\n\t\t\t\tconst resultJson:ResultJSON={\n\t\t\t\t\tcode:-1,\n\t\t\t\t\tmsg:\"添加失败\",\n\t\t\t\t\tfaceFeature: \"\",\n\t\t\t\t\tfaceID:\"\",\n\t\t\t\t\tfaceBase64:\"\"\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tcallback(resultJson)\n\t\t\t}\n\t\t} \n\t});\n}\n\n\n\n/**\n * 1:N，M：N 人脸搜索，开发测试中 完善一下参数\n * \n */\nexport const faceSearch:FaceSearch = function(callback: (res: ResultJSON) => void){\n\t\n\tconst context = UTSAndroid.getUniActivity() as Activity\n\tFaceSDKConfig.init(context);\n\t\n\tconst intent = new Intent(context, FaceSearch1NActivity().javaClass)\n\tcontext.startActivity(intent)\n\t\n\tconst resultJson:ResultJSON={\n\t\tcode: 1,\n\t\tmsg: \"开发测试中\",\n\t\tfaceID: \"faceID8\",\n\t\tfaceBase64: \"64\",\n\t\tfaceFeature: \"\"\n\t}\n    callback(resultJson)\n} \n","// 插件对外暴露能力的总入口在 interface.uts ，他与Android/ios 目录下的 index.uts的关系是声明和实现的关系。\n\n\n\n\n\n/**\n * 开启持续人脸搜索 (Activity 常驻)\n * @param callback 接收搜索结果 JSON 字符串的回调\n */\nexport type StartFaceSearch = (callback: (jsonResult: string) => void) => void\n\n\n\n/**\n * 「1:N人脸搜索」录入人脸特征值\n * \n * @param faceID 用户ID\n * @param callback 结果回调\n */\nexport type AddFaceSearchFeature = (\n    faceID:string,\n\taddFacePerformanceMode:number,\n\tcallback : (result : ResultJSON) => void) => void\n\t\n\t\n\t\n/**\n * 「1:N人脸搜索」删除一张人脸照片\n * \n * @param faceID 用户ID\n * @param callback 结果回调\n */\nexport type DeleteFaceSearchFeature = (\n    faceID:string,\n\tcallback : (result : ResultJSON) => void) => void\n\n\n/**\n * 「1:N人脸搜索」更多个性化参数完善中\n */\nexport type FaceSearch = (callback: (res: ResultJSON) => void) => void\n\n\n/**\n * 「1:N人脸搜索」录入一张人脸照片\n * \n * @param faceID 用户ID\n * @param faceFeature 1024长度的提取的人脸特征值\n * @param tag   标签\n * @param group 分组\n * @param callback 结果回调\n */\nexport type InsertFaceSearchFeature = (\n\tfaceID : string,\n\tfaceFeature : string, \n\ttag : string, \n\tgroup : string,\n\tcallback : (result : ResultJSON) => void) => void\n\t\n\t\n/**\n * 「1:N人脸搜索」录入一张人脸照片\n * \n * @param jsonFaceFeatures json 格式数组\n * @param callback 结果回调\n */\nexport type InsertManyFeatures = (\n\tjsonFaceFeatures : string,\n\tcallback : (result : ResultJSON) => void) => void\n\t\n\n\n/**\n * 业务方传给FaceAISDK 插件基础参数\n */\nexport type ResultJSON = {\n  code: number,       //code 含义参考Readme \n  msg: string, \n  faceID: string,     \n  faceFeature: string,  //人脸特征值\n  faceBase64: string    //人脸图Base64编码\n}"],"names":[],"mappings":"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"}